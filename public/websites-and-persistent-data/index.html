<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.0.3/css/bootstrap.min.css">
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.0.3/css/bootstrap-theme.min.css">
</head>
<body>
	<div class="container">
		<div class="page-header">
			<h1>Websites and Persistent Data</h1>
			<p class="lead">This tutorial walks you through creating a website utilizing persistent data storage. You will learn how to access an SQL database and manage data for your website.</p>
			<p>Prequisites</p>
			<ul>
				<li>HTML</li>
				<li>Basic Object Oriented Programming.</li>
				<li>Access to a MySQL Database</li>
			</ul>
			<p>* This tutorial intends to walk you through concepts and is designed to be langauge agnostic. Although this tutorial uses a specific language as the server side programming language, the concepts can be coded in any language.</p>
		</div>

		<div class="row">
			<div class="panel-group" id="Design_Specifications_Section">
				<div class="panel panel-default">
					<div class="panel-heading">
						<a data-toggle="collapse" data-parent="#Design_Specifications_Section" href="#Design_Specifications">
							<h4 class="panel-title">
								Design Specifications
							</h4>
						</a>
					</div>
					<div id="Design_Specifications" class="panel-collapse collapse">
						<div class="panel-body">
							TODO: Add Design Specifications diagram.
						</div>
					</div>
				</div>
			</div>
		</div>
		<br>
		<div class="row">
			<div class="panel-group" id="CGI_Responder_Section">
				<div class="panel panel-default">
					<div class="panel-heading">
						<a data-toggle="collapse" data-parent="#CGI_Responder_Section" href="#CGI_Responder">
							<h4 class="panel-title">
								CGI responder
							</h4>
						</a>
					</div>
					<div id="CGI_Responder" class="panel-collapse collapse">
						<div class="panel-body">
<p>Create a responder.<b>php</b> file on the website with the following code:</p>
<pre>
&lt;?php
    print "Hello\n";
?>
</pre>

<h4>Test the program</h4>
<p>Test the program on the server</p>
<pre>
php responder.php
</pre>

<p>Remotely test program using cURL</p>
<pre>
curl -k <b>"http://__URL__/response.php"</b>
</pre>

<p>The server should respond to both with the following:</p>
<pre>
Hello
</pre>
						</div>
					</div>
				</div>
			</div>
		</div>
		<br>
		<div class="row">
			<div class="panel-group" id="SQL_Tables_Section">
				<div class="panel panel-default">
					<div class="panel-heading">
						<a data-toggle="collapse" data-parent="#SQL_Tables_Section" href="#SQL_Tables">
							<h4 class="panel-title">
								SQL Tables
							</h4>
						</a>
					</div>
					<div id="SQL_Tables" class="panel-collapse collapse">
						<div class="panel-body">
<p>Creating a Database table.</p>

<p>Create the following files:</p>

							<div class="panel-group" id="SQL_Tables_Files_Section">
								<div class="panel panel-default">
									<div class="panel-heading">
										<a data-toggle="collapse" data-parent="#SQL_Tables_Files_Section" href="#SQL_Tables_Config">
											<h4 class="panel-title">
												Config.php.example
											</h4>
										</a>
									</div>
									<div id="SQL_Tables_Config" class="panel-collapse collapse">
										<div class="panel-body">
											<p>This file contains the site specific configuration for the program.</p>
											<p>Create the following <strong>Config.php.example</strong> file:</p>
<pre>
&lt;?php
namespace Websites_And_Persistent_Data;

class Config {
    const Database_Engine = 'mysql';
    const Hostname = '';
    const Username = '';
    const Password = '';
    const Database = '';
    const Table_Prefix = "EX_";
}
?>
</pre>
											<p>This file is named Config.php<strong><i>.example</i></strong> to provide an example configuration for the program. It is helpful when using version control systems to create examples for files containing private data. The example file can be checked into version control and a copy made for site specific implemention.</p>
											<p>Copy this file to create a <strong>Config.php</strong> configured for your environment.</p>
										</div>
									</div>
								</div>

								<div class="panel panel-default">
									<div class="panel-heading">
										<a data-toggle="collapse" data-parent="#SQL_Tables_Files_Section" href="#SQL_Tables_Database">
											<h4 class="panel-title">
												Database.php
											</h4>
										</a>
									</div>
									<div id="SQL_Tables_Database" class="panel-collapse collapse">
										<div class="panel-body">
											<p>This file contains database connection initialization program.</p>
											<p>Create the following <strong>Database.php</strong> file:</p>
<pre>
&lt;?php
namespace Websites_And_Persistent_Data;

class Database {
    public static function initialize ($engine, $hostname, $username, $password, $database)
    {
        $dsn = "$engine:host=$hostname;dbname=$database";
        try {
            $dbh = new \PDO($dsn, $username, $password);
            $dbh->setAttribute(\PDO::ATTR_ERRMODE, \PDO::ERRMODE_EXCEPTION);
        }
        catch (\PDOException $e) {
            die("Connection failed: " . $e->getMessage() . "\n");
        }

        return $dbh;
    }
}
?>
</pre>
										</div>
									</div>
								</div>

								<div class="panel panel-default">
									<div class="panel-heading">
										<a data-toggle="collapse" data-parent="#SQL_Tables_Files_Section" href="#SQL_Tables_Todo">
											<h4 class="panel-title">
												Todo.php
											</h4>
										</a>
									</div>
									<div id="SQL_Tables_Todo" class="panel-collapse collapse">
										<div class="panel-body">
											<p>This file contains the Todo object implementation.</p>
											<p>Create the following <strong>Todo.php</strong> file:</p>
<pre>
&lt;?php
namespace Websites_And_Persistent_Data;

class Todo {
    private static $table_name = 'todo';
    private static $primary_key = 'todo_id';

    private $table_prefix;
    private $dbh;

    public function __construct ($prefix, $dbh) {
        $this->table_prefix = $prefix;
        $this->dbh = $dbh;
    }

    public function create () {
        $table = $this->table_prefix . self::$table_name;

        $query = "
            CREATE TABLE IF NOT EXISTS $table (
                  todo_id INTEGER PRIMARY KEY AUTO_INCREMENT
                , task TEXT
                , completed INTEGER DEFAULT 0
            )
            ";

        $sth = $this->dbh->prepare($query);
        $sth->execute();

        return true;
    }
}
?>
</pre>
											<p>The Todo object currently contains only the constructor and the create methods. The contructor initializes a Todo instance. The create method creates the database table.</p>
											<p>Subsequent Todo methods will be added to this file.</p>
										</div>
									</div>
								</div>

								<div class="panel panel-default">
									<div class="panel-heading">
										<a data-toggle="collapse" data-parent="#SQL_Tables_Files_Section" href="#SQL_Tables_Responder">
											<h4 class="panel-title">
												responder.php
											</h4>
										</a>
									</div>
									<div id="SQL_Tables_Responder" class="panel-collapse collapse">
										<div class="panel-body">
											<p>This file contains the responder program to run tests.</p>
											<p>Update the <strong>responder.php</strong> file:</p>
<pre>
&lt;?php
namespace Websites_And_Persistent_Data;

require 'Config.php';
require 'Database.php';
require 'Todo.php';

$dbh = Database::initialize(
      Config::Database_Engine
    , Config::Hostname
    , Config::Username
    , Config::Password
    , Config::Database
    );

$todo = new Todo(
      Config::Table_Prefix
    , $dbh
    );

try {
    print "Create: ";
    print $todo->create() . "\n";
}
catch (\PDOException $e) {
    die("Error: " . $e->getMessage() . "\n");
}
?>
</pre>
											<p>This responder runs a preliminary tests of the program thus far.</p>
										</div>
									</div>
								</div>
							</div>
							<br>
							<p>Run the responder.php program</p>
							<p>Check the database to ensure the todo table is created.</p>
<pre>
mysql -u USERNAME -p -D DATABASE -e "show tables"
mysql -u USERNAME -p -D DATABASE -e "describe EX_todo"
</pre>
						</div>
					</div>
				</div>
			</div>
		</div>
		<br>
		<div class="row">
			<div class="panel-group" id="SQL_Queries_Section">
				<div class="panel panel-default">
					<div class="panel-heading">
						<a data-toggle="collapse" data-parent="#SQL_Queries_Section" href="#SQL_Queries">
							<h4 class="panel-title">
									SQL Queries
							</h4>
						</a>
					</div>
					<div id="SQL_Queries" class="panel-collapse collapse">
						<div class="panel-body">
							<p>The methods in this section are additional Todo object methods. Add these to the Todo class implementation.</p>
							<div class="panel-group" id="SQL_Queries_Command_Section">
								<div class="panel panel-default">
									<div class="panel-heading">
										<a data-toggle="collapse" data-parent="#SQL_Queries_Command_Section" href="#SQL_Queries_Show_Record_list">
											<h4 class="panel-title">
												Show Record Index
											</h4>
										</a>
									</div>
									<div id="SQL_Queries_Show_Record_list" class="panel-collapse collapse">
										<div class="panel-body">
<pre>
    public function index () {
        $table = $this->table_prefix . self::$table_name;

        $query = "
            SELECT * FROM $table
            ";

        $sth = $this->dbh->prepare($query);
        $sth->execute();

        return $sth->fetchAll(\PDO::FETCH_ASSOC);
    }
</pre>
										</div>
									</div>
								</div>
								<div class="panel panel-default">
									<div class="panel-heading">
										<a data-toggle="collapse" data-parent="#SQL_Queries_Command_Section" href="#SQL_Queries_Show_Record">
											<h4 class="panel-title">
												Show Record
											</h4>
										</a>
									</div>
									<div id="SQL_Queries_Show_Record" class="panel-collapse collapse">
										<div class="panel-body">
<pre>
    public function show ($id) {
        if (! is_numeric($id)) {
            return false;
        }

        $table = $this->table_prefix . self::$table_name;
        $primary_key = self::$primary_key;

        $query = "
            SELECT * FROM $table
            WHERE $primary_key = :todo_id
            ";

        $sth = $this->dbh->prepare($query);
        $sth->bindParam(':todo_id', $id, \PDO::PARAM_INT);
        $sth->execute();

        return $sth->fetch(\PDO::FETCH_ASSOC);
    }
</pre>
										</div>
									</div>
								</div>
								<div class="panel panel-default">
									<div class="panel-heading">
										<a data-toggle="collapse" data-parent="#SQL_Queries_Command_Section" href="#SQL_Queries_Store_Record">
											<h4 class="panel-title">
												Store Record
											</h4>
										</a>
									</div>
									<div id="SQL_Queries_Store_Record" class="panel-collapse collapse">
										<div class="panel-body">
<pre>
    public function store ($task) {
        $table = $this->table_prefix . self::$table_name;
        $primary_key = self::$primary_key;

        $query = "
            INSERT INTO $table(task)
            VALUES (:task)
            ";

        $sth = $this->dbh->prepare($query);
        $sth->bindParam(':task', $task, \PDO::PARAM_STR);
        $sth->execute();

        return true;
    }
</pre>
										</div>
									</div>
								</div>
								<div class="panel panel-default">
									<div class="panel-heading">
										<a data-toggle="collapse" data-parent="#SQL_Queries_Command_Section" href="#SQL_Queries_Update_Record">
											<h4 class="panel-title">
												Update Record
											</h4>
										</a>
									</div>
									<div id="SQL_Queries_Update_Record" class="panel-collapse collapse">
										<div class="panel-body">
<pre>
    public function update ($id, $task) {
        if (! is_numeric($id)) {
            return false;
        }
        $table = $this->table_prefix . self::$table_name;
        $primary_key = self::$primary_key;

        $query = "
            UPDATE $table
            SET task = :task
            WHERE $primary_key = :todo_id
            ";

        $sth = $this->dbh->prepare($query);
        $sth->bindParam(':todo_id', $id, \PDO::PARAM_INT);
        $sth->bindParam(':task', $task, \PDO::PARAM_STR);
        $sth->execute();

        return true;
    }
</pre>
										</div>
									</div>
								</div>
								<div class="panel panel-default">
									<div class="panel-heading">
										<a data-toggle="collapse" data-parent="#SQL_Queries_Command_Section" href="#SQL_Queries_Delete_Record">
											<h4 class="panel-title">
												Delete Record
											</h4>
										</a>
									</div>
									<div id="SQL_Queries_Delete_Record" class="panel-collapse collapse">
										<div class="panel-body">
<pre>
    public function delete ($id) {
        if (! is_numeric($id)) {
            return false;
        }
        $table = $this->table_prefix . self::$table_name;
        $primary_key = self::$primary_key;

        $query = "
            DELETE FROM $table
            WHERE $primary_key = :todo_id
            ";

        $sth = $this->dbh->prepare($query);
        $sth->bindParam(':todo_id', $id, \PDO::PARAM_INT);
        $sth->execute();

        return true;
    }
</pre>
										</div>
									</div>
								</div>
								<div class="panel panel-default">
									<div class="panel-heading">
										<a data-toggle="collapse" data-parent="#SQL_Queries_Command_Section" href="#SQL_Queries_Responder">
											<h4 class="panel-title">
												responder.php
											</h4>
										</a>
									</div>
									<div id="SQL_Queries_Responder" class="panel-collapse collapse">
										<div class="panel-body">
											Additional Todo object tests. Replace the try block in the responder with he following:
<pre>

...

try {
    print "Create: ";
    print $todo->create() . "\n";

    print "Index:\n";
    print json_encode($todo->index()) . "\n";

    print "Store: ";
    print json_encode($todo->store("Task 1")) . "\n";
    print json_encode($todo->index()) . "\n";
    $record_id = $todo->index()[0]['todo_id'];

    print "Show: ";
    $record = $todo->show($record_id);
    print json_encode($record) . "\n";

    print "Update: ";
    print json_encode($todo->update($record['todo_id'], "Task A")) . "\n";
    print json_encode($todo->index()) . "\n";

    print "DELETE: ";
    print json_encode($todo->delete($record['todo_id'])) . "\n";
    print json_encode($todo->index()) . "\n";
}

...

</pre>
										</div>
									</div>
								</div>
							</div>
							<br>
							<p>Run the responder.php program. If all went well, the responder shows the results</p>
						</div>
					</div>
				</div>
			</div>
		</div>
		<br>
		<div class="row">
			<div class="panel-group" id="SQL_Injection_Warning_Section">
				<div class="panel panel-default">
					<div class="panel-heading">
						<a data-toggle="collapse" data-parent="#SQL_Injection_Warning_Section" href="#SQL_Injection_Warning">
							<h4 class="panel-title">
								SQL Injection Warning
							</h4>
						</a>
					</div>
					<div id="SQL_Injection_Warning" class="panel-collapse collapse">
						<div class="panel-body">
							<p>In data driven applications, <a href="http://en.wikipedia.org/wiki/SQL_injection">SQL injection</a> is an attack inserted into a form entry field intended for exection by the database server. When taking inputs from the user, the program must sanitize the input values to prevent this from occuring.</p>
							<p>In the following code snippet, notice there is a placeholder where the query requires the todo_id value. After the query is prepared the program performs checks on the todo_id value then binds the intended value to the statement handler before executing the SQL query.</p>
<p><pre>
$query = "
    SELECT * FROM $table
    WHERE $primary_key = <b>:todo_id</b>
    ";

$sth = $this->dbh->prepare($query);
$sth->bindParam('<b>:todo_id</b>', $id, \PDO::PARAM_INT);
$sth->execute();
</pre></p>
							<p><span class="text-danger">Always assume that someone is going to maliciously attack your program.</span> Deny all access, allow only what is needed, and be sure to sanitize all input from outside the program.</p>
						</div>
					</div>
				</div>
			</div>
		</div>

		<h3>Conclusion</h3>


	</div>
	<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.0.3/js/bootstrap.min.js"></script>
</body>
</html>

